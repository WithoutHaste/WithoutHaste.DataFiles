[Home](README.md)

# Design

## Reflection

1) An assembly cannot be loaded by System.Reflection if it was built with a higher target framework than the running assembly.

2) NuGet cannot load a library into a project if the library uses a higher target framework than the current project.

Therefore, in order for DataFiles.DotNet to be added to a project and to be able to use Reflection on that project, their target frameworks must be the same.

To maximize the usefulness of DataFiles.DotNet, the NuGet package must include builds for every target framework >= 2.0.

The test and build process will need to be automated.

## Extension Methods

Extension methods are not supported in .Net 2.0, but are supported in all higher target frameworks.

Those parts of the code need to be compiled conditionally based on the current target framework.

## Func

Func-type is supported in .Net 3.5 and higher.

Library LINQlone does include its own 2.0 Func object.

DotNetSettings.QualifiedNameConverter and AdditionalQualifiedNameConverter are Func-types. I don't want users to have to use the same 2.0 compatibility library I'm using.

Therefore, with frameworks 2.0 and 3.0, the QualifiedNameConverter can be toggled on/off with a method, and the AdditionalQualifiedNameConverter will not be available.

## Building

In order to support all the different target frameworks, the main project generates altered *.sln and *.csproj files for each framework.

After making changes to the solution: re-run generateSolutionFiles.tt

After making changes to the DataFiles project: re-run generateProjectFiles.tt

After making changes to the DataFilesTest project: re-run generateTestProjectFiles.tt

To build and test all targeted versions:  
1) Command Prompt > DataFiles folder: compileDebugProjects.bat  
2) Command Prompt > DataFilesTest folder: compileDebugProjects.bat  
3) Developer Command Prompt > DataFilesTest folder: runTestsDebugProjects.bat  
- verify tests were successful  
4) Command Prompt > DataFiles folder: compileReleaseProjects.bat  

### BuildVerification

`msbuild` sometimes ignores the target framework I've specified for the projects, even though it's in the *.csproj file and also in the command-line build command.

So this looks into each compiled assembly and checks what framework it actually targets.

Good values are ImageRuntimeVersion="v2.0..." for targets 2.0 through 3.5 and "v4.0..." above that.  
Bad values are ImageRuntimeVersion="v4.0..." for targets 2.0 through 3.5.

### Documentation

Projects for net20, net35, and net40 will generate independent documentation.

These are the points in framework progression when the DataFiles documentation is affected.

## Automated Testing

### DataFilesTest

Unit tests for the WithoutHaste.DataFiles library.

### ExcelTest

Unit tests for the WithoutHaste.DataFiles.Excel library.

### LaterFrameworkTest

Supports DataFilesTest.

A project targeting a later framework, so that trying to load a later-framework-project can be tested.

### ThirdPartyTest

Supports DataFilesTest.

A project depending on a third party library, so that trying to generate documentation for such a project can be tested.

### InstallationTests

Automated testing of installing the full WithoutHaste.DataFiles NuGet package in a project targeting each framework.

_That was the goal, but it doesn't work because command-line-nuget will not update the project files. So this will set up projects for each framework, but I have to manually run the installation and check that it worked._

Folder "Template" contains the fully setup project from which the automated tests are generated. "Template" runs very simple operations against WithoutHaste.DataFiles; essentially smoke-tests for each namespace.

Run "DataFiles/createAndTestPackage.bat" to setup and run these tests.

Batch file:  
1) Compiles Release configuration of WithoutHaste.DataFiles for each target framework.  
2) Builds the single multi-targeted Nuget package.  
3) Copies the NuGet package to the local test source folder.  
- Will need to manually publish the package and wait for it to be Verified and Indexed.
4) Runs InstallationTestsSetup.exe
- removes old auto-generated tests
- makes copies of Template for each target framework under the AutoGenerated folder
- edits copies in preparation for test
5) Install WithoutHaste.DataFiles NuGet package into each auto-generated project.  
6) Build each auto-generated project.  
7) Run each auto-generated project.  
